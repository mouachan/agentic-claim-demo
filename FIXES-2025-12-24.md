# Corrections du 24 Décembre 2025

Ce document décrit les deux problèmes identifiés et leurs solutions.

## Problème 1: PostgreSQL ENUM - Noms des Steps ✅

### Symptôme
```
ERROR: invalid input value for enum processing_step: "ocr_document"
LINE 1: INSERT INTO processing_logs (claim_id, step, agent_name, ...
```

### Cause Racine
L'ENUM `processing_step` dans la base de données contenait les anciennes valeurs:
- `ocr`
- `guardrails`
- `rag_retrieval`
- `llm_decision`
- `final_review`

Mais l'orchestrateur intelligent utilise les nouveaux noms de tools:
- `ocr_document`
- `retrieve_user_info`
- `retrieve_similar_claims`
- `make_final_decision`

### Solution Appliquée
Création d'une migration SQL pour ajouter les nouvelles valeurs à l'ENUM:

**Fichier:** `database/migrations/001_add_intelligent_orchestrator_steps.sql`

```sql
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'ocr_document';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_user_info';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_similar_claims';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'make_final_decision';
```

### Comment Appliquer la Migration

#### Option 1: Via oc exec (Recommandé)
```bash
# Copier le fichier SQL dans le pod PostgreSQL
oc cp database/migrations/001_add_intelligent_orchestrator_steps.sql \
  claims-demo/postgresql-0:/tmp/migration.sql

# Exécuter la migration
oc exec -n claims-demo -it statefulset/postgresql -- \
  psql -U claimsuser -d claimsdb -f /tmp/migration.sql

# Vérifier les nouvelles valeurs
oc exec -n claims-demo -it statefulset/postgresql -- \
  psql -U claimsuser -d claimsdb -c "SELECT unnest(enum_range(NULL::processing_step));"
```

#### Option 2: Via psql directement
```bash
# Se connecter à PostgreSQL
oc exec -n claims-demo -it statefulset/postgresql -- \
  psql -U claimsuser -d claimsdb

# Dans le prompt psql, exécuter:
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'ocr_document';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_user_info';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_similar_claims';
ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'make_final_decision';

# Vérifier:
\dT+ processing_step
```

### Vérification
```bash
# Tester le traitement d'un claim après la migration
CLAIM_ID=$(curl -s https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/api/v1/claims | jq -r '.claims[0].id')

curl -X POST "https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/api/v1/claims/${CLAIM_ID}/process"

# Vérifier les logs - ne devrait plus avoir d'erreur ENUM
oc logs -n claims-demo deployment/backend --tail=50 | grep -i "enum"
```

---

## Problème 2: Backend API Routes 404 ✅

### Symptôme
```bash
$ curl -s https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/api/claims
{"detail":"Not Found"}
```

### Cause Racine
Le prefix API configuré est `/api/v1` et non `/api`.

**Configuration dans:** `backend/app/core/config.py:20`
```python
api_v1_prefix: str = "/api/v1"
```

**Routes enregistrées dans:** `backend/app/main.py:93-94`
```python
app.include_router(claims.router, prefix=f"{settings.api_v1_prefix}/claims", tags=["claims"])
app.include_router(documents.router, prefix=f"{settings.api_v1_prefix}/documents", tags=["documents"])
```

### Solution
Pas de changement de code nécessaire. Simplement utiliser les bonnes URLs:

#### URLs Correctes ✅
- Root: `https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/`
- Health: `https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/health/ready`
- **Claims API:** `https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/api/v1/claims` ⬅️
- **Documents API:** `https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com/api/v1/documents` ⬅️

#### URLs Incorrectes ❌
- ~~`/api/claims`~~ → 404
- ~~`/api/documents`~~ → 404

### Script de Test
Un script de test a été créé avec les bonnes URLs:

**Fichier:** `scripts/test-api-endpoints.sh`

```bash
# Exécuter tous les tests
./scripts/test-api-endpoints.sh

# Ou tester manuellement
BACKEND_URL="https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com"

# Liste des claims
curl -s "${BACKEND_URL}/api/v1/claims" | jq '.'

# Claims pending
curl -s "${BACKEND_URL}/api/v1/claims?status=pending" | jq '.'

# Détails d'un claim
curl -s "${BACKEND_URL}/api/v1/claims/{claim_id}" | jq '.'

# Process claim
curl -X POST "${BACKEND_URL}/api/v1/claims/{claim_id}/process" \
  -H "Content-Type: application/json" \
  -d '{}' | jq '.'

# Status du traitement
curl -s "${BACKEND_URL}/api/v1/claims/{claim_id}/status" | jq '.'

# Logs du traitement
curl -s "${BACKEND_URL}/api/v1/claims/{claim_id}/logs" | jq '.'
```

---

## Vérification End-to-End

Une fois les deux fixes appliqués, voici le test complet:

### 1. Appliquer la migration PostgreSQL
```bash
oc exec -n claims-demo -it statefulset/postgresql -- \
  psql -U claimsuser -d claimsdb -c "
    ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'ocr_document';
    ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_user_info';
    ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'retrieve_similar_claims';
    ALTER TYPE processing_step ADD VALUE IF NOT EXISTS 'make_final_decision';
  "
```

### 2. Lister les claims disponibles
```bash
BACKEND_URL="https://backend-claims-demo.apps.cluster-rk6mx.rk6mx.sandbox492.opentlc.com"

curl -s "${BACKEND_URL}/api/v1/claims" | jq '.claims[] | {id, claim_number, status}'
```

### 3. Traiter un claim
```bash
# Récupérer un claim_id pending
CLAIM_ID=$(curl -s "${BACKEND_URL}/api/v1/claims?status=pending" | jq -r '.claims[0].id')

echo "Processing claim: $CLAIM_ID"

# Lancer le traitement
curl -X POST "${BACKEND_URL}/api/v1/claims/${CLAIM_ID}/process" | jq '.'
```

### 4. Vérifier les logs
```bash
# Logs orchestrateur
oc logs -n claims-demo deployment/orchestrator-server --tail=100

# Logs backend
oc logs -n claims-demo deployment/backend --tail=100

# Vérifier qu'il n'y a plus d'erreur ENUM
oc logs -n claims-demo deployment/backend --tail=200 | grep -i "enum"
```

### 5. Vérifier la base de données
```bash
oc exec -n claims-demo -it statefulset/postgresql -- \
  psql -U claimsuser -d claimsdb -c "
    SELECT
      c.claim_number,
      c.status,
      pl.step,
      pl.agent_name,
      pl.status as step_status,
      pl.created_at
    FROM claims c
    LEFT JOIN processing_logs pl ON c.id = pl.claim_id
    WHERE c.id = '${CLAIM_ID}'
    ORDER BY pl.created_at;
  "
```

### Résultat Attendu ✅
```
 claim_number | status | step                     | agent_name                    | step_status | created_at
--------------+--------+--------------------------+-------------------------------+-------------+------------
 CLM-001      | ...    | ocr_document             | ocr-document-agent            | completed   | ...
 CLM-001      | ...    | retrieve_user_info       | retrieve-user-info-agent      | completed   | ...
 CLM-001      | ...    | retrieve_similar_claims  | retrieve-similar-claims-agent | completed   | ...
 CLM-001      | ...    | make_final_decision      | make-final-decision-agent     | completed   | ...
```

---

## Résumé des Fichiers Modifiés/Créés

### Créés
- ✅ `database/migrations/001_add_intelligent_orchestrator_steps.sql` - Migration ENUM
- ✅ `scripts/test-api-endpoints.sh` - Script de test API
- ✅ `FIXES-2025-12-24.md` - Cette documentation

### À Modifier (Optionnel)
Si on veut changer le prefix de `/api/v1` vers `/api`:
- `backend/app/core/config.py:20` → `api_v1_prefix: str = "/api"`
- Redéployer le backend

**Recommendation:** Garder `/api/v1` pour versionning API futur

---

## Prochaines Étapes

1. ✅ Migration PostgreSQL appliquée
2. ✅ Tests API avec bonnes URLs
3. ⏳ Test end-to-end complet
4. ⏳ Mettre à jour frontend pour utiliser `/api/v1` au lieu de `/api`
5. ⏳ Documentation utilisateur finale

---

## Notes Importantes

- PostgreSQL ENUM: Les valeurs ne peuvent pas être supprimées, seulement ajoutées
- Les anciennes valeurs (`ocr`, `guardrails`, etc.) restent disponibles
- Le prefix `/api/v1` est intentionnel pour le versionning
- Tous les tests doivent utiliser `/api/v1` et non `/api`
